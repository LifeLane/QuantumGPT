
// This file is generated by Firebase Genkit.
'use server';

/**
 * @fileOverview AI Trading Strategy Suggestion flow.
 *
 * - suggestTradingStrategy - A function that suggests a trading strategy for a given cryptocurrency.
 * - SuggestTradingStrategyInput - The input type for the suggestTradingStrategy function.
 * - SuggestTradingStrategyOutput - The return type for the suggestTradingStrategy function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';
import { getCryptoMarketDataTool, type MarketData, MarketDataSchema } from '@/ai/tools/market-data-tool';

const SuggestTradingStrategyInputSchema = z.object({
  cryptocurrency: z.string().describe('The ticker symbol of the cryptocurrency to analyze (e.g., BTC).'),
  riskTolerance: z.enum(['low', 'medium', 'high']).describe('The user\'s risk tolerance level.'),
});
export type SuggestTradingStrategyInput = z.infer<typeof SuggestTradingStrategyInputSchema>;

const SuggestTradingStrategyOutputSchema = z.object({
  strategyExplanation: z.string().describe('A detailed explanation of the suggested trading strategy, considering the current market price obtained via the market data tool and common chart analysis principles.'),
  currentPrice: z.number().optional().describe('The current market price of the cryptocurrency, as reported by the market data tool and used as a basis for this strategy suggestion. This is the direct output from the tool if data was available.'),
  entryPoint: z.number().describe('An illustrative suggested entry point for the trade, derived by the AI based on the strategy and the fetched current price.'),
  exitPoint: z.number().describe('An illustrative suggested exit point for the trade, derived by the AI based on the strategy.'),
  stopLossLevel: z.number().describe('An illustrative suggested stop-loss level for the trade, derived by the AI based on the strategy.'),
  profitTarget: z.number().describe('An illustrative profit target for the trade, derived by the AI based on the strategy.'),
  disclaimer: z
    .string()
    .describe(
      'A disclaimer emphasizing that all trading involves risk. The current price is fetched via a tool (using live data from Messari API if available, otherwise simulated). All other figures (entry, exit, stop-loss, profit target) are illustrative suggestions generated by the AI based on its analysis and are NOT live financial advice. Consult a financial expert.'
    ),
});
export type SuggestTradingStrategyOutput = z.infer<typeof SuggestTradingStrategyOutputSchema>;

export async function suggestTradingStrategy(input: SuggestTradingStrategyInput): Promise<SuggestTradingStrategyOutput> {
  return suggestTradingStrategyFlow(input);
}

const prompt = ai.definePrompt({
  name: 'suggestTradingStrategyPrompt',
  input: {schema: z.object({ // Prompt input includes fetched market data
    cryptocurrency: SuggestTradingStrategyInputSchema.shape.cryptocurrency,
    riskTolerance: SuggestTradingStrategyInputSchema.shape.riskTolerance,
    marketData: MarketDataSchema.nullable().describe("Current market data for the cryptocurrency. This will be fetched by a tool prior to calling you."),
  })},
  output: {schema: SuggestTradingStrategyOutputSchema},
  prompt: `You are an AI-powered trading strategy advisor with expertise in technical chart analysis.

You will suggest an optimal trading strategy for the selected cryptocurrency.
Your strategy should be informed by the current market data provided ('marketData') AND general principles of chart analysis as if you were looking at a TradingView chart.

Current market data from the tool:
- Price: {{#if marketData.price}}{{marketData.price}}{{else}}not available{{/if}}
- 24h Volume: {{#if marketData.volume24h}}{{marketData.volume24h}}{{else}}not available{{/if}}
- 24h Price Change: {{#if marketData.priceChange24hPercent}}{{marketData.priceChange24hPercent}}%{{else}}not available{{/if}}

Inputs:
- Cryptocurrency: {{{cryptocurrency}}}
- Risk Tolerance: {{{riskTolerance}}}

Consider the following when formulating your strategy, acting as if you are analyzing a standard TradingView chart for this cryptocurrency:
- The current market data (price, volume, 24h change from the 'marketData' object). This is your primary source for the current state. If this data is not available, state that and make a more general suggestion.
- Common technical analysis patterns that might be visible on a chart (e.g., trendlines, support/resistance levels, chart formations like triangles, wedges, head and shoulders). Base this on general knowledge of how these patterns appear and what they signify, applied to the current market context.
- Common technical indicators and their typical interpretations (e.g., Moving Averages (MAs), Relative Strength Index (RSI), Moving Average Convergence Divergence (MACD)). For example, consider if the price is above/below key MAs, if RSI is overbought/oversold, or if MACD shows a bullish/bearish crossover. Apply this based on general knowledge in relation to the provided current price.
- User's risk tolerance (low, medium, high).

Provide the following:
- Strategy Explanation: A clear and concise explanation of the suggested strategy, integrating your chart analysis reasoning and how it relates to the fetched current price.
- Current Price: The current price that was fetched by the market data tool (from 'marketData.price', if available). This value is the direct output from the tool.
- Entry Point: A recommended price to enter the trade. This is an illustrative figure derived by your analysis based on the fetched current price and your chart interpretation.
- Exit Point: A recommended price to exit the trade. This is an illustrative figure derived by your analysis.
- Stop-Loss Level: A price level at which to set a stop-loss order. This is an illustrative figure derived by your analysis.
- Profit Target: A price level at which to take profit. This is an illustrative figure derived by your analysis.
- Disclaimer: A standard disclaimer. Emphasize that the current price is from the tool (Messari API or simulated), but all other strategy figures (entry, exit, etc.) are AI-derived illustrative examples based on its analysis (including conceptual chart analysis) and are not live financial advice.

Format your response as a JSON object with the fields: strategyExplanation, currentPrice, entryPoint, exitPoint, stopLossLevel, profitTarget, and disclaimer.
If current market data was not available from the tool, the currentPrice field can be omitted or set to null, and your strategy should reflect this lack of live data.
`,
});

const suggestTradingStrategyFlow = ai.defineFlow(
  {
    name: 'suggestTradingStrategyFlow',
    inputSchema: SuggestTradingStrategyInputSchema,
    outputSchema: SuggestTradingStrategyOutputSchema,
  },
  async (input: SuggestTradingStrategyInput) => {
    let marketData: MarketData | null = null;
    try {
      marketData = await getCryptoMarketDataTool({symbol: input.cryptocurrency});
    } catch (toolError) {
      console.error(`Error calling getCryptoMarketDataTool for ${input.cryptocurrency}:`, toolError);
    }

    const {output} = await prompt({
        ...input,
        marketData: marketData,
    });
    
    if (!output) {
        throw new Error("The AI model did not return the expected output format for trading strategy.");
    }
    
    if (marketData && marketData.price && output.currentPrice === undefined) {
        output.currentPrice = marketData.price;
    }
    
    return output;
  }
);

